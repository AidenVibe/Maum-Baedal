# 사용자 알림 시나리오 - 알림톡 운영 전략

마음배달 프로젝트의 알림톡 기반 사용자 알림 시스템 설계 문서

## 📋 알림 시나리오 인덱스

| 시나리오 | 트리거 시점 | 대상자 | 목적 | 우선순위 |
|----------|-------------|---------|------|----------|
| **🌅 아침 브로드캐스트** | 매일 08:00 | 모든 활성 사용자 | 일일 루틴 형성 | **S급** |
| **📤 질문 공유 알림** | 질문 공유 시 | 공유받는 상대방 | 참여 유도 | **S급** |
| **💝 상대방 답변 알림** | 한쪽 답변 완료 시 | 미답변자 | 답변 촉구 | **S급** |
| **🎉 게이트 완전 공개** | 양쪽 답변 완료 시 | 해당 동반자 둘 다 | 만족도 극대화 | **S급** |
| **🌙 저녁 리마인드** | 매일 19:00 | 미답변자만 | 완료율 향상 | **A급** |
| **💤 휴면 복귀 알림** | 7일+ 미접속 | 휴면 사용자 | 비용 절감 | **B급** |

---

## 개요

**핵심 철학**: 가족 소통의 확실성을 보장하기 위한 알림톡 기반 시스템

**예상 효과**:
- 완료율: 45% → 70% (25%p 상승)
- 연속 참여율: 30% → 65% (35%p 상승)  
- 사용자 만족도: 60% → 85% (25%p 상승)

**총 예상 비용**: 월 24,000원 (사용자 100명 기준, 1인당 240원)

**핵심 개선사항**:
- ✅ **중복 알림 50% 제거**: 불필요한 대기 알림 제거로 12,000원/월 절약
- ✅ **개인화 시간 선택**: 3x3 시간 옵션으로 알림 효과성 30% 증대
- ✅ **가족시간 배려**: 저녁 알림을 21시로 조정하여 가족 식사시간 회피

---

## Phase 1: 필수 알림 (높은 ROI)

### 시나리오 1: 개인화 브로드캐스트 (사용자 선택 시간)

**설정**:
- **트리거 조건**: 매일 사용자 설정 시간, 새 서비스 데이 시작
- **시간 선택지**: 08시(출근전), 10시(오전휴식), **12시(점심시간, 기본값)**
- **대상자**: 알림 활성화된 모든 사용자
- **발송 빈도**: 1일 1회
- **개인화 효과**: 각자 라이프스타일에 맞는 최적 시간 설정 가능

**메시지 템플릿**:
```
🌅 [마음배달] 오늘의 질문이 도착했어요!

#{nickname}님, 좋은 #{time_greeting}이에요!
오늘 #{partner_name}님과 나눌 따뜻한 이야기가 준비되었습니다.

※ time_greeting: 08시=아침, 10시=오전, 12시=점심시간

📝 오늘의 질문
"#{question_text}"

🏠 답변하러 가기
https://dearq.app/today

💝 05시까지 한 줄만 남겨주세요
#마음배달 #가족대화
```

**기대효과**: 일상 루틴 형성, 안정적 참여율 확보 (70%+)  
**예상 비용**: 월 1,500건 (50 동반자 기준) = 15,000원

---

### 시나리오 2: 질문 공유 알림 (실시간)

**설정**:
- **트리거 조건**: 한쪽 사용자가 질문을 상대방과 공유할 때
- **대상자**: 질문을 공유받는 상대방 1명
- **발송 조건**: 상대방이 아직 답변하지 않은 상태

**메시지 템플릿 (둘 다 미답변인 경우)**:
```
📤 [마음배달] #{sender_name}님이 오늘의 질문을 보냈어요!

#{nickname}님, 안녕하세요!
#{sender_name}님이 함께 답변할 질문을 공유했습니다 ✨

📝 오늘의 질문
"#{question_text}"

함께 따뜻한 대화를 시작해볼까요?

👀 질문 확인하기
https://dearq.app/today

#마음배달 #함께시작해요
```

**메시지 템플릿 (보낸이가 이미 답변한 경우)**:
```
💝 [마음배달] #{sender_name}님이 답변을 완료했어요!

#{nickname}님, #{sender_name}님이 먼저 답변을 남겼습니다!
이제 당신의 솔직한 생각을 들려주세요 😊

📝 오늘의 질문
"#{question_text}"

🔐 두 분 모두 답변하면 바로 공개됩니다

👀 답변하러 가기
https://dearq.app/today

#마음배달 #당신차례예요
```

**기대효과**: 즉시 참여 유도, 공유 활성화  
**예상 비용**: 월 400건 = 4,000원

---

### 시나리오 3: 상대방 답변 알림 (실시간)

**설정**:
- **트리거 조건**: 한쪽이 답변을 완료했을 때 (질문 공유와는 별개)
- **대상자**: 아직 답변하지 않은 상대방 1명
- **발송 조건**: 상대방 미답변 + 마지막 접속 후 30분 경과 시

**메시지 템플릿**:
```
💌 [마음배달] #{partner_name}님이 답변을 기다리고 있어요!

궁금하지 않나요? 
#{partner_name}님의 솔직한 생각이 준비되어 있습니다 ✨

당신의 답변도 함께하면 
서로의 마음을 확인할 수 있어요 💙

📝 답변하러 가기
https://dearq.app/today

#마음배달 #함께쓰면열리는마음의문
```

**기대효과**: 상호작용 촉진, 높은 완료율 (85%+)  
**예상 비용**: 월 600건 = 6,000원

---

### 시나리오 4: 게이트 완전 공개 알림 (실시간)

**설정**:
- **트리거 조건**: 2명 모두 답변 완료, Conversation 생성 시
- **대상자**: 해당 동반자 2명 모두
- **발송 조건**: 게이트 공개 후 5분 이내
- **중복 방지**: 마지막 답변자에게는 "답변 완료 + 게이트 공개" 통합 알림

**🚫 마지막 답변자 알림 제거**: 화면 내 토스트 메시지로 대체
- **UX 개선**: 이미 화면에서 게이트 공개를 확인한 사용자에게 추가 알림톡 없이
- **비용 절감**: 알림톡 비용 50% 절약
- **토스트 대체**: "🎉 축하해요! 마음의 문이 활짝 열렸습니다!" + "대화 보기" 버튼

**메시지 템플릿 (먼저 답변한 사용자용)**:
```
🎊 [마음배달] #{partner_name}님 답변 완료! 대화가 시작되었어요!

#{partner_name}님이 답변을 완료해서
두 분의 따뜻한 대화가 시작되었습니다 ✨

서로의 마음을 확인하고 
더 깊은 이야기를 나눠보세요

💬 대화 확인하기  
https://dearq.app/today

#마음배달 #대화완성
```

**기대효과**: 핵심 가치 실현, 만족도 극대화 + UX 혁신  
**예상 비용**: 월 300건 = 3,000원 (마지막 답변자 알림 제거로 50% 절감)
**UX 개선**: 마지막 답변자는 화면 내 토스트로 즉시 피드백

**Phase 1 총 비용**: 28,000원/월 (사용자당 280원)

---

## Phase 2: 선택적 알림 (성과 기반 도입)

### 시나리오 5: 개인화 리마인드 (사용자 선택 시간)

**설정**:
- **트리거 조건**: 매일 사용자 설정 시간, 미답변 상태인 사용자만
- **시간 선택지**: 17시(퇴근시간), 19시(기존), **21시(저녁후, 권장)**
- **대상자**: 아직 답변하지 않은 사용자
- **발송 조건**: 전체 완료율 <70% 인 날만 발송
- **가족시간 배려**: 21시 권장으로 저녁 식사시간 방해 방지

**메시지 템플릿 (21시 권장 버전)**:
```
✨ [마음배달] #{partner_name}님이 기다리고 있어요

하루 고생 많으셨어요!
이제 여유로운 시간, 따뜻한 대화 한 번 어떠세요?

⏰ 05시까지 충분한 시간이 있어요
편안하게 한 줄만 남겨주세요 😊

📝 답변하러 가기  
https://dearq.app/today

#마음배달 #잠깐만시간내기
```

**기대효과**: 완료율 10-15% 상승  
**예상 비용**: 월 400건 = 4,000원

**Phase 2 추가 비용**: +4,000원/월  
**누적 비용**: 35,000원/월

---

## Phase 3: 휴면 관리 (비용 절감)

### 시나리오 6: 휴면 복귀 알림

**설정**:
- **트리거 조건**: 7일 이상 미접속 사용자 대상
- **대상자**: 휴면 사용자 (파트너는 활성 상태일 때)
- **발송 빈도**: 7일, 14일 차에만 (총 2회, 간소화)
- **목적**: 휴면자 조기 발견으로 불필요한 알림 비용 절약
- **간소화 이유**: 14일 내 복귀 없으면 장기 휴면으로 간주, 비용 효율성 우선

**메시지 템플릿 (7일차)**:
```
💙 [마음배달] #{partner_name}님이 그리워해요

#{nickname}님, 잘 지내고 계신가요?
#{partner_name}님이 혼자서 대화를 이어가고 있어요

잠깐만 시간을 내어 
따뜻한 마음을 다시 나눠보시겠어요?

🏠 마음배달 돌아가기
https://dearq.app/today

언제든 돌아오시면 환영합니다 🤗
#마음배달 #다시만나요
```

**메시지 템플릿 (14일차, 최종)**:
```
💌 [마음배달] 마지막 알림을 드려요

#{nickname}님, 2주간 만나지 못했네요
#{partner_name}님이 많이 그리워하고 계셨어요

혹시 알림이 부담되시나요?
설정에서 알림을 조정하실 수 있습니다

⚙️ 알림 설정하기
https://dearq.app/settings

다시 함께하고 싶으시면 언제든 환영해요 💝
#마음배달 #또만나요
```

**기대효과**: 휴면 복귀율 25%, 장기 휴면자 비용 절약  
**예상 비용**: 월 70건 = 700원 (14일 단축으로 30% 절약)

**최종 총 비용**: 25,700원/월 (사용자당 257원)

---

## 비용 대비 효과 매트릭스

| 시나리오 | 월 발송량 | 월 비용 | 기대효과 | ROI 등급 |
|----------|----------|---------|-----------|----------|
| **개인화 브로드캐스트** | 1,500건 | 15,000원 | 참여율 70% | **S급** |
| **질문 공유 알림** | 200건 | 2,000원 | 공유 활성화 | **S급** |
| **상대방 답변 알림** | 300건 | 3,000원 | 재방문 85% | **S급** |
| **게이트 공개 (최적화)** | 300건 | 3,000원 | 만족도 극대화 + 토스트 | **S급** |
| **개인화 리마인드** | 200건 | 2,000원 | 완룄율 +15% | **A급** |
| **휴면 복귀 알림** | 70건 | 700원 | 비용 절약 25% | **B급** |
| | | **총 25,700원** | **토스트 도입으로 추가 절감** | |

## 단계별 도입 전략

### 🚀 Phase 1 (즉시 적용) - 중복 알림 제거
- **개선사항**: 불필요한 "대기" 알림 50% 제거
- **비용 절감**: 36,000원 → 25,700원 (28.6% 절약)
- **사용자 경험**: 알림 피로도 대폭 감소

### 📱 Phase 2 (1-2주 내) - 개인화 시간 선택
- **기능**: 3x3 시간 선택지 시스템 구현
- **효과**: 알림 효과성 30% 증대
- **기술 요구**: User 테이블 확장, 동적 크론잡

### 🧪 Phase 3 (향후) - A/B 테스트 인프라
- **목적**: 데이터 기반 최적화
- **대상**: 일일알림 vs 리마인드 시간 효과 분석
- **장기**: AI 기반 개인 최적 시간 추천

## 핵심 권장사항

1. **즉시 도입 필수**: 아침 브로드캐스트 + 실시간 3종 (게이트 관련)
2. **1개월 운영 후 검토**: 저녁 리마인드 추가 여부 판단
3. **3개월 후 평가**: 휴면 관리 시스템 도입 검토

---

## 📱 개인화된 알림 시간 시스템

### 시간 선택 매트릭스

**일일 브로드캐스트 옵션:**
- **08시**: 출근 전 여유시간 (아침형 인간) - 25% 선택 예상
- **10시**: 오전 업무 정리 후 (직장인) - 30% 선택 예상  
- **12시**: 점심시간 (가장 안전) - 45% 선택 예상 ✅ 기본값

**리마인드 알림 옵션:**
- **17시**: 퇴근시간 직전 (직장인) - 30% 선택 예상
- **19시**: 저녁식사시간 (⚠️ 가족시간 방해위험) - 25% 선택 예상
- **21시**: 저녁 일정 후 개인시간 (추천) - 45% 선택 예상 ✅ 권장

### 사용자별 최적화 전략

```typescript
// 개인화 시간 설정 예시
interface UserNotificationSettings {
  dailyHour: 8 | 10 | 12    // 기본값: 12 (점심시간)
  reminderHour: 17 | 19 | 21 // 기본값: 21 (저녁후)
  timezone: 'KST'           // 한국시간 고정
  isActive: boolean         // 알림 전체 on/off
}
```

**예상 효과:**
- 🎯 **개인화 적중률**: 각자 라이프스타일에 맞는 시간 설정으로 응답률 30% 증가
- 👨‍👩‍👧‍👦 **가족 배려**: 21시 옵션으로 저녁 식사시간 방해 최소화
- 📊 **데이터 수집**: 사용자 선호 시간대 분석을 통한 향후 서비스 개선

---

## 🎉 토스트 메시지 시스템 도입

### 핵심 개념: 알림톡→토스트 전환의 UX 철학

**기존 문제점**:
- 마지막 답변자가 화면에서 게이트 공개를 확인한 후 추가로 알림톡까지 받는 **정보 중복**
- 사용자가 이미 아는 정보를 다시 알려주는 **UX 원칙 위반**
- 불필요한 알림톡 비용 발생

**개선된 플로우**:
```
김대리: 답변 완료 → (대기) → 이선생 완료시 알림톡 ✅
이선생: 답변 완료 → 화면 내 토스트 ✅ + 게이트 즉시 확인
```

### React 토스트 시스템 구현

```typescript
// components/ui/toast/ToastProvider.tsx
'use client'
import { createContext, useContext, useState } from 'react'

type ToastType = 'success' | 'error' | 'info' | 'gate-opened'

interface Toast {
  id: string
  type: ToastType
  message: string
  duration?: number
  action?: () => void
}

const ToastContext = createContext<{
  toasts: Toast[]
  addToast: (toast: Omit<Toast, 'id'>) => void
  removeToast: (id: string) => void
  showGateOpened: (onViewConversation?: () => void) => void
}>(null as any)

export function ToastProvider({ children }: { children: React.ReactNode }) {
  const [toasts, setToasts] = useState<Toast[]>([])
  
  const addToast = (toast: Omit<Toast, 'id'>) => {
    const id = Math.random().toString(36)
    const newToast = { ...toast, id }
    
    setToasts(prev => [...prev.slice(-2), newToast]) // 최대 3개 제한
    
    // 자동 제거
    setTimeout(() => removeToast(id), toast.duration || 5000)
  }
  
  const showGateOpened = (onViewConversation?: () => void) => {
    addToast({
      type: 'gate-opened',
      message: '🎉 축하해요! 마음의 문이 활짝 열렸습니다!',
      duration: 8000, // 게이트 공개는 더 오래 표시
      action: onViewConversation
    })
  }
  
  const removeToast = (id: string) => {
    setToasts(prev => prev.filter(toast => toast.id !== id))
  }
  
  return (
    <ToastContext.Provider value={{ toasts, addToast, removeToast, showGateOpened }}>
      {children}
      <ToastContainer />
    </ToastContext.Provider>
  )
}

// 게이트 공개 전용 토스트 컴포넌트
function GateOpenedToast({ toast, onClose }: { toast: Toast, onClose: () => void }) {
  return (
    <div className="fixed bottom-20 left-4 right-4 z-50 animate-slide-up">
      <div className="bg-gradient-to-r from-pink-500 to-purple-600 text-white p-6 rounded-2xl shadow-2xl">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
              ✨
            </div>
            <span className="font-bold text-lg">{toast.message}</span>
          </div>
          <button onClick={onClose} className="text-white/80 hover:text-white">
            ×
          </button>
        </div>
        
        <div className="flex space-x-3">
          <button 
            onClick={toast.action}
            className="flex-1 bg-white/20 hover:bg-white/30 py-3 px-4 rounded-xl font-medium transition-colors"
          >
            💬 대화 보기
          </button>
          <button 
            onClick={onClose}
            className="bg-white/10 hover:bg-white/20 py-3 px-4 rounded-xl transition-colors"
          >
            나중에
          </button>
        </div>
        
        {/* 파티클 효과 */}
        <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2">
          <div className="flex space-x-1">
            {[...Array(5)].map((_, i) => (
              <div 
                key={i} 
                className="w-2 h-2 bg-yellow-300 rounded-full animate-bounce"
                style={{ animationDelay: `${i * 0.1}s` }}
              />
            ))}
          </div>
        </div>
      </div>
    </div>
  )
}

export const useToast = () => {
  const context = useContext(ToastContext)
  if (!context) {
    throw new Error('useToast must be used within ToastProvider')
  }
  return context
}
```

### 답변 제출 로직과 토스트 연동

```typescript
// components/features/today/AnswerForm.tsx
import { useToast } from '@/components/ui/toast/ToastProvider'
import { useRouter } from 'next/navigation'

export function AnswerForm() {
  const { showGateOpened, addToast } = useToast()
  const router = useRouter()
  
  const handleSubmit = async (answer: string) => {
    try {
      const response = await fetch('/api/answer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answer })
      })
      
      const result = await response.json()
      
      if (result.gateStatus === 'opened' && result.isLastAnswerer) {
        // 🎉 마지막 답변자: 화려한 게이트 공개 토스트
        showGateOpened(() => {
          router.push('/today#conversation')
        })
      } else {
        // ✅ 일반 성공: 간단한 확인 토스트
        addToast({
          type: 'success',
          message: '답변이 저장되었습니다. 상대방의 답변을 기다리고 있어요.'
        })
      }
      
    } catch (error) {
      addToast({
        type: 'error',
        message: '답변 저장 중 오류가 발생했습니다.'
      })
    }
  }
}
```

### 비용 효과 및 UX 개선

**알림톡 비용 절감**:
- 게이트 공개 시: 2건 → 1건 발송 (50% 절감)
- 월 절감액: 1,500원 (300건 × 5원)

**사용자 경험 향상**:
- 🎉 **즉시 피드백**: 답변 완료 순간 화면에서 축하 메시지
- 🚀 **자연스러운 플로우**: "대화 보기" 버튼으로 바로 게이트 확인
- 💫 **시각적 임팩트**: 그라데이션 + 파티클 효과로 특별한 순간 연출
- 📱 **모바일 최적화**: Safe area 고려한 하단 고정 위치

---

## 🔧 기술적 구현 가이드

### 알림 중복 방지 로직
```typescript
// 게이트 공개 시 중복 알림 방지 (개선된 로직)
async function sendGateOpenedNotifications(assignmentId: string, lastAnswerUserId: string) {
  const assignment = await getAssignmentWithUsers(assignmentId)
  const [user1, user2] = assignment.companion.users
  
  // 🚫 중복 제거: 마지막 답변자에게만 통합 알림 발송
  await sendNotification(lastAnswerUserId, 'ANSWER_COMPLETE_AND_GATE_OPENED', {
    nickname: lastAnswerUserId === user1.id ? user1.nickname : user2.nickname,
    partnerName: lastAnswerUserId === user1.id ? user2.nickname : user1.nickname,
    message: '답변 완료! 마음의 문이 열렸어요!'
  })
  
  // 먼저 답변한 사용자: 게이트 공개 알림만 (답변 완료는 이미 받음)
  const firstAnswerUserId = lastAnswerUserId === user1.id ? user2.id : user1.id
  await sendNotification(firstAnswerUserId, 'PARTNER_COMPLETED_GATE_OPENED', {
    nickname: firstAnswerUserId === user1.id ? user1.nickname : user2.nickname,
    partnerName: lastAnswerUserId === user1.id ? user1.nickname : user2.nickname,
    message: '상대방 답변 완료! 대화가 시작되었어요!'
  })
}

// 🔥 핵심 개선: "김대리 케이스" 문제 해결
// ❌ 기존: 김대리 답변완료 → "이선생 대기중" 불필요 알림 → 게이트공개
// ✅ 개선: 김대리 답변완료 → (대기, 알림없음) → 이선생 완료시 게이트공개
async function handleAnswerSubmission(userId: string, assignmentId: string) {
  // 답변 저장
  await saveAnswer(userId, assignmentId)
  
  const answerCount = await getAnswerCount(assignmentId)
  
  if (answerCount === 1) {
    // 첫 번째 답변자: 아무 알림 없음 (대기 상태)
    // 🚫 "상대방이 답변하면..." 같은 불필요한 알림 제거
    console.log('First answer submitted, waiting for partner')
  } else if (answerCount === 2) {
    // 두 번째 답변자: 게이트 공개 처리
    await sendGateOpenedNotifications(assignmentId, userId)
  }
}
```

### 휴면 사용자 관리
```typescript
// 개인화 시간 기반 알림 발송 시스템
async function sendPersonalizedNotifications() {
  // 시간대별 사용자 그룹핑
  const users08 = await getUsersByNotificationHour(8)
  const users10 = await getUsersByNotificationHour(10)  
  const users12 = await getUsersByNotificationHour(12)
  
  // 각 시간대별 배치 발송
  await Promise.all([
    sendDailyBroadcast(users08, '좋은 아침'),
    sendDailyBroadcast(users10, '좋은 오전'),
    sendDailyBroadcast(users12, '좋은 점심시간')
  ])
}

// 휴면 사용자 관리 (간소화: 14일 단축)
async function identifyInactiveUsers() {
  const inactiveUsers = await prisma.user.findMany({
    where: {
      lastActiveAt: {
        lt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) // 7일 전
      },
      notificationSettings: {
        isActive: true // 알림은 활성화되어 있지만 접속 안함
      }
    }
  })
  
  // 🔥 간소화: 7일, 14일만 알림 후 비활성화 (30일 제거)
  for (const user of inactiveUsers) {
    const daysSinceInactive = getDaysSince(user.lastActiveAt)
    
    if ([7, 14].includes(daysSinceInactive)) {
      await sendInactiveUserNotification(user, daysSinceInactive)
    } else if (daysSinceInactive > 14) {
      await deactivateNotifications(user.id) // 비용 절약 (14일→비활성화)
    }
  }
}
```

---

## 결론

**월 25,700원으로 가족 소통의 품질을 혁신적으로 개선**할 수 있는 종합 전략입니다.

핵심 개선사항:
- ✅ **중복 알림 50% 제거**: "김대리 케이스" 등 불필요한 대기 알림 제거로 12,000원/월 절약
- ✅ **개인화 시간 선택**: 3x3 시간 매트릭스로 알림 효과성 30% 증대
- ✅ **가족시간 배려**: 리마인드 21시 권장으로 저녁 식사시간 방해 방지
- ✅ **휴면 관리 간소화**: 14일 단축으로 효율적 비용 관리
- ✅ **사용자 경험 향상**: 알림 피로도 감소와 개인 맞춤화의 완벽한 균형

특히 **개선된 게이트 공개 시스템**은 마음배달의 핵심 가치인 **"함께 쓰면 열리는 마음의 문"** 경험을 완벽하게 구현하면서도:

🎯 **"행동 완료자는 대기, 미완료자는 액션 유도"** 원칙으로 중복 알림을 근본적으로 해결
📱 **개인화된 시간 선택**으로 각 가정의 라이프스타일에 맞춘 최적의 알림 경험 제공
💰 **50% 비용 절감**으로 더 많은 가족이 부담 없이 이용할 수 있는 서비스 실현

99% 도달률을 보장하는 알림톡으로 확실한 소통을 실현하고, 단계별 알림으로 자연스러운 참여를 유도하는 것이 성공의 핵심입니다.